name: Quick HTML Update (no data reprocessing)

on:
  workflow_dispatch:
    inputs:
      description:
        description: 'What UI changes are you deploying?'
        required: false
        default: 'UI improvements'

jobs:
  quick-deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Install R packages (minimal)
        run: |
          Rscript -e 'pkgs <- c("jsonlite");
                      inst <- setdiff(pkgs, rownames(installed.packages()));
                      if(length(inst)) install.packages(inst, repos="https://cloud.r-project.org")'

      - name: Download existing processed data
        run: |
          set -euo pipefail
          
          echo "ðŸ“¥ Downloading ALL existing files from gh-pages..."
          
          mkdir -p public/total public/daily public/monthly
          
          git clone --depth 1 --branch gh-pages \
            https://github.com/evelynebrie/hq-outages-public.git temp-public
          
          rsync -av --exclude='.git' temp-public/ public/
          rm -rf temp-public
          
          echo "âœ… Downloaded all existing files"
          echo "Contents:"
          ls -lh public/
          ls -lh public/total/ || echo "No total/ directory"

      - name: Regenerate HTML only
        run: |
          echo "ðŸŽ¨ Regenerating HTML with UI fixes..."
          
          if [ ! -f "R/generate_html_only.R" ]; then
            echo "âŒ ERROR: R/generate_html_only.R not found!"
            exit 1
          fi
          
          Rscript R/generate_html_only.R
          
          if [ ! -f "public/index.html" ]; then
            echo "âŒ ERROR: HTML generation failed!"
            exit 1
          fi
          
          echo "âœ… HTML generated successfully"
          ls -lh public/index.html

      - name: Deploy to public repo (gh-pages)
        uses: peaceiris/actions-gh-pages@v3
        with:
          personal_token: ${{ secrets.PUBLIC_REPO_TOKEN }}
          external_repository: evelynebrie/hq-outages-public
          publish_branch: gh-pages
          publish_dir: public
          commit_message: "Quick HTML update: ${{ github.event.inputs.description }}"
          
      - name: Summary
        run: |
          echo "âœ… Quick deployment complete!"
          echo ""
          echo "ðŸŒ View at: https://evelynebrie.github.io/hq-outages-public/"
          echo ""
          echo "â±ï¸  Total time: ~2-3 minutes (vs 20-30 for full reprocessing)"
          echo ""
          echo "ðŸ“ Changes deployed: ${{ github.event.inputs.description }}"
