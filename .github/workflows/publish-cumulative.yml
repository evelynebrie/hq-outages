name: Publish cumulative exposure map

on:
  schedule:
    - cron: "0 5 * * *"  # every day at 5 AM UTC (midnight Montreal time)
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: System libs
        run: sudo apt-get update && sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev libudunits2-dev libgdal-dev libgeos-dev libproj-dev

      - name: Install R packages
        run: |
          Rscript -e 'pkgs <- c("httr","jsonlite","dplyr","tidyr","stringr","lubridate","arrow","sf","readr");
                      inst <- setdiff(pkgs, rownames(installed.packages()));
                      if (length(inst)) install.packages(inst, repos="https://cloud.r-project.org")'

      - name: Build cumulative hex map
        run: Rscript R/build_cumulative_hex.R

      - name: Deploy to public repo
        uses: peaceiris/actions-gh-pages@v3
        with:
          personal_token: ${{ secrets.PUBLIC_REPO_TOKEN }}
          external_repository: evelynebrie/hq-outages-public
          publish_branch: gh-pages
          publish_dir: ./public
          commit_message: "Update cumulative outage exposure map"
